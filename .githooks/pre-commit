#!/bin/bash

set -euo pipefail

echo "üîç Checking if .proto files are in sync..."

# Create and clean temp dir
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# Prepare temp output path
mkdir -p "$TEMP_DIR/pkg/api"

# Generate proto into TEMP_DIR using identical flags to Makefile
protoc \
  --proto_path=./ \
  --go_out="$TEMP_DIR/pkg" --go_opt=paths=source_relative \
  --go-grpc_out="$TEMP_DIR/pkg" --go-grpc_opt=paths=source_relative \
  api/compute.proto

# Compare with current pkg/api
if ! diff -qr "$TEMP_DIR/pkg/api" pkg/api > /dev/null; then
  echo "‚ùå Protobufs are out of sync. Please run: make proto"
  exit 1
fi

echo "‚úÖ Protobufs are in sync."
